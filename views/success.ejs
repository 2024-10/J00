<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
  </head>
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/payment_result.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.9.6/lottie.min.js"></script>
  <body>
    <header id="main-header">
        <a href="/">
            <img src="/images/logo.svg" alt="logo" class="logo">
        </a>
        <button id="nav-toggle" class="nav-toggle">
            <span class="nav-icon"></span>
            <span class="nav-icon"></span>
            <span class="nav-icon"></span>
        </button>
        <nav id="main-navigation">
            <ul class="menu">
                <li class="menu-item"><button onclick="window.location.href='/mandalart'" class="nav-button">My Mandalart</button></li>
                <li class="menu-item"><button onclick="window.location.href='/share'" class="nav-button">Share</button></li>
                <li class="menu-item"><button onclick="window.location.href='/calendar'" class="nav-button">Calendar</button></li>
                <li class="menu-item"><button onclick="window.location.href='/profile'" class="nav-button">Profile</button></li>
            </ul>
        </nav>
    </header>
    
    <div class="main">
        <div id="lottie-animation" style="width: 213px; height: 321px;"></div>
        <div class="title">멤버십 결제가 완료되었습니다</div>
        <div class="subtitle">당신의 목표가 실현될 때까지 J00%와 함께해요!</div>

        <!-- paymentKey, orderId, amount를 표시할 요소 추가 -->
        <div id="paymentKey"></div>
        <div id="orderId"></div>
        <div id="amount"></div>
    </div>

    <script>
        var animation = lottie.loadAnimation({
            container: document.getElementById('lottie-animation'),
            renderer: 'svg',
            loop: true, 
            autoplay: true, 
            path: '/images/rocket.json' 
        });
        
        // 쿼리 파라미터 값이 결제 요청할 때 보낸 데이터와 동일한지 반드시 확인하세요.
        // 클라이언트에서 결제 금액을 조작하는 행위를 방지할 수 있습니다.
        const urlParams = new URLSearchParams(window.location.search);
        const paymentKey = urlParams.get("paymentKey");
        const orderId = urlParams.get("orderId");
        const amount = urlParams.get("amount");

        async function confirm() {
            const requestData = {
                paymentKey: paymentKey,
                orderId: orderId,
                amount: amount,
            };

            const response = await fetch("/payment/confirm", {
                method: "POST",
                headers: {
                "Content-Type": "application/json",
                },
                body: JSON.stringify(requestData),
            });

            const json = await response.json();

            if (!response.ok) {
                console.log(json);
                window.location.href = `/fail?message=${json.message}&code=${json.code}`;
                return;
            }

            console.log(json);
        }

        confirm();

        const orderIdElement = document.getElementById("orderId");
        const amountElement = document.getElementById("amount");

        orderIdElement.textContent = "주문번호: " + orderId;
        amountElement.textContent = "결제 금액: " + amount;
    </script>
  </body>
</html>